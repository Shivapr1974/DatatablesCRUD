<html>
	<head>
		<script src="JS/jquery-1.12.3.js"></script>
		<script src="JS/jquery.dataTables.min.js"></script>
		<script src="JS/global.js"></script>
		<script src="JS/csv.js"></script>
		<script src="JS/fileSaver.js"></script>

		<link rel="stylesheet" type="text/css" href="CSS/jquery.dataTables.min.css"/>
		<link rel="stylesheet" type="text/css" href="CSS/global.css"/>
		<script>
				var table = undefined;
				// [ "<img class=imgdetail  src='IMAGES/edit.png' onclick=\"handleClick('edit', 0)\">", "Tiger Nixon", "System Architect", "Edinburgh", "5421", "2011/04/25", "$320,800" , "<img class=imgdetail  src='IMAGES/delete.png' onclick=\"handleClick('delete', 0)\">" ],

				var origDataSet = [
						[ "5421", "Tiger Nixon", "A"],
						[ "8422", "Gart Winter", "B"],		
						[ "8423", "Lary Winter", "B"],		
				];
				// localStorage.setItem("studentList", JSON.stringify(origDataSet));
				// try{ origDataSet = JSON.parse(localStorage.getItem("studentList")); 
				// }catch(e){ 
				// 	origDataSet = getCookieAndParse("studentList", []); 
				// }
				origDataSet = getData("studentList", []);
				if( checkNull(origDataSet)){
					origDataSet = [];
				}					
				var userObject = {};	
				var dataSet = origDataSet;
				resetDataSet();
				$(document).ready(function() {
					setDataSource();
					$("#printContent").hide();
				} );
			
				function resetDataSet(){
					var arrayDataset = []
					
					// try{ localStorage.setItem("studentList", JSON.stringify(origDataSet)); 
					// }catch(e){ 
					// 	setCookie("studentList", JSON.stringify(origDataSet)); 
					// }
					setData("studentList", origDataSet);
					for (var i = 0; i < origDataSet.length; i++) {
						var icons = setIcons(i);
						var detail = icons.detail;
						var edit =   icons.edit;
						var del =    icons.del;
						var arr = JSON.parse(JSON.stringify(origDataSet[i]));
						arr.push(detail);
						arr.push(del);
						arr.push(edit);
						// var arr = [...origDataSet[i], detail, del, edit];
						arrayDataset.push(arr);
						userObject[origDataSet[i][0]] = JSON.parse(JSON.stringify(origDataSet[i]));
					}
				 	dataSet = arrayDataset;
				}

				function setDataSource(){
					table = $('#example').DataTable( {
									data: dataSet,
									"iDisplayLength": 5,
									"lengthMenu": [[5, 10, -1], [5, 10, "All"]],
									columns: [
										{ title: "Number" },
										{ title: "Name" },
										{ title: "Grade" },
										{ title: "Community<br>Service" },
										{ title: "Delete" },
										{ title: "Edit" },
									]
								} );
				}	
				function reloadData(){
					$('#example').DataTable().clear().destroy();					
					setDataSource();		
					$("#printContent").hide();
				}	
				function formClear() {
					$("#txtRow").val("");
					$("#txtDetails").val("");
					$("#txtID").val("");
					$("#txtName").val("");
					$("#txtGrade").val("");
					$("#errorID").text("");
					$("#errorName").text("");
					$("#errorGrade").text("");
					$("#txtDelete").val("");
					$("#txtEdit").val("");			
					$( "#txtID" ).prop( "disabled", false );							
				}				
				
				function validate(){
					$("#errorID").text("");
					$("#errorName").text("");
					$("#errorGrade").text("");					
					var row = $("#txtRow").val();
					var id = $("#txtID").val();
					var name = $("#txtName").val();
					var grade = $("#txtGrade").val();
					var error = false;
					var requiredMessage="This field is required."
					var arr = userObject[id];
					if(checkNull(id) ){
						error = true;
						$("#errorID").text(requiredMessage);
					}
					if(checkNull(row) && !checkNull(userObject[id]) ){
						error = true;
						$("#errorID").text("Duplicate. Student with Id exists.");
					}
					if(checkNull(name) ){
						error = true;
						$("#errorName").text(requiredMessage);
					}
					if(checkNull(grade) ){
						error = true;
						$("#errorGrade").text(requiredMessage);
						
					}			
					return error;							
				}
				function saveData() {
					if( validate()) {
						return;
					}
					var row = $("#txtRow").val();
					var add = false;
					if(row === undefined || row === ""){
						row = dataSet.length;
						add = true;
					}					
					var icons = setIcons(row);
					var detail = icons.detail;
					var edit =   icons.edit;
					var del =    icons.del;				
					var array = [$("#txtID").val(), $("#txtName").val(), $("#txtGrade").val()];
					if(add){
						origDataSet.push(array);
					}else{
						origDataSet[row] = array;								 
					}	
					resetDataSet();							 
					reloadData();
					formClear();
				}	
				function handleClick(type, row){
						console.log(' TYPE ---------- ' + type);
						const vals = dataSet[row];
						console.log(vals);
						if(type === 'edit'){
							$("#txtRow").val(row);
							$("#txtID").val(vals[0]);
							$("#txtName").val(vals[1]);
							$("#txtGrade").val(vals[2]);
							$("#txtDetails").val(vals[3]);
							$("#txtDelete").val(vals[4]);
							$("#txtEdit").val(vals[5]);
							$( "#txtID" ).prop( "disabled", true );							
						}
						if(type === 'delete'){
							origDataSet.splice(row, 1);
							resetDataSet();	
							reloadData();
							formClear();
						}	
						if( type === 'details'){
							var id = vals[0];
							var name = vals[1];
							url = "detail.html?id="+id+"&name="+encodeURIComponent(name);
							// MyWindow=window.open(url,'Details','width=900,height=650');
							MyWindow=popupwindow(url, 'Details', 900, 650);
						}
				}
				function popupwindow(url, title, w, h) {
					var left = (screen.width/2)-(w/2);
					var top = (screen.height/2)-(h/2) -20;
					return window.open(url, title, 
					'toolbar=no, location=no, directories=no, status=no, menubar=no, '+
					'scrollbars=no, resizable=no, copyhistory=no, width='+w+', height='+h+', top='+top+', left='+left);
				} 
				function addHours( a, b){
					if(checkNull(a)) a  = 0;
					if(checkNull(b)) b  = 0;
					return a + b;
				}	
				function getTableData(){
					var reportDuration = $("#reportDuration").val();
					var reportType = $("#reportType").val();
					var reportTitle = "Report";
					if(reportDuration === 'W'){
						reportTitle = " Weekly " + reportTitle;
					}else {
						reportTitle = " Monthly " + reportTitle;
					}
					if(reportType === 'S'){
						reportTitle = "Student " + reportTitle;
					}else {
						reportTitle = "Program " + reportTitle;
					}						
					$('#printTitleText').text(reportTitle);		

					var tableContent = [ ];
					var communityServObject = {
					"5421": [
								[12, "Medical", "2020-01-15"],
								[2, "Animal", "2020-01-18"],
							],
					"8422": [
								[12, "Medical", "2020-02-15"],
								[2,  "Church", "2020-01-18"],
							],
					"8423": [
								[12, "Church", "2020-03-15"],
								[2,  "Animal", "2020-01-19"],
							],
					};					
					// try{ 				
					// 	communityServObject = JSON.parse(localStorage.getItem("communityService"));
					// }catch(e){ 
					// 	communityServObject = JSON.parse(getCookie("communityService")); 
					// }
					communityServObject = getData("communityService", {});
					//Normalize Values
					var reportObjArray = [];
					for (var key in communityServObject) {
						var communityServArray = communityServObject[key];
						if(communityServArray === undefined ) continue;
						for(i=0;i<=communityServArray.length;i++){
							var values = communityServArray[i];
							if(values === undefined ) continue;
						 	var arr = JSON.parse(JSON.stringify(values));
							 arr.unshift(userObject[key][1]);
							 arr.unshift(key);
							 reportObjArray.push(arr);
						}
					}
					reportObject = {};
					var totalHours = 0;
					for(i=0;i<reportObjArray.length;i++){
						var id = reportObjArray[i][0];
						var name = reportObjArray[i][1];
						var hours = parseInt(reportObjArray[i][2] +"");
						var type = reportObjArray[i][3];
						var dateArray = reportObjArray[i][4].split("-");
						var date = new Date(dateArray[1]+"/"+dateArray[2]+"/"+dateArray[0]);
						var week = date.getWeek();
						var month = date.getMonthStr();
						var year = date.getFullYear();
						// console.log(date + ' - ' + reportObjArray[i][4] + ' - ' + 
						// 					year + ' - ' + 
						// 					week + ' - ' + 
						// 					month );
						var monthKey = month + "/" + year;
						var weekKey = week + "/" + year;
						var nameKey = name  + "-" + id ;
						var key = "";
						var duration = "";
						if(reportDuration === 'W'){
							key = weekKey
							duration = "WEEK";
						}else {
							key = monthKey
							duration = "MONTH";
						}
						if(reportType === 'S'){
							key = key + "-" + nameKey;
							tableContent = [[duration,'NAME','ID','HOURS']];		
						}else {
							key = key + "-" + type;
							tableContent = [[duration,'TYPE','HOURS']];							
						}						
						reportObject[key] = addHours( reportObject[key], hours);
						totalHours = addHours( totalHours, hours);
					}	

					console.log(reportObject);
					console.log("Total Hours " + totalHours);
					
					for (var key in reportObject) {
						var arr = key.split("-");
						var hours = reportObject[key];
						arr.push(hours)
						// arr = [...arr, hours];
						tableContent.push(arr);
					}	
					if(reportType === 'S'){
						tableContent.push(['TOTAL', '','', totalHours]);
					}else{
						tableContent.push(['TOTAL', '', totalHours]);
					}	

					return tableContent;
				}	
				function setTableData(){
					var tableContent = getTableData();
					table = $('#printTableBody');
					table.empty();
					table.append('<tr>');
					header = tableContent[0];	
					for (var j = 0; j < header.length; j++) {
						table.append('<th>' + header[j] + '</th>');
					}
					table.append('</tr>');

					for (var i = 1; i < tableContent.length ; i++) {
						var row = tableContent[i];
						table.append('<tr>');
						var rowClass = "odd";
						if(i % 2 == 0){
							rowClass = "even";
						}
						for (var j = 0; j < row.length; j++) {
							table.append('<td class="'+ rowClass + '">' + row[j] + '</td>');
						}
						table.append('</tr>');
					}

				}
				function printContent(el){
					setTableData();
					$("#printContent").show();					
					$('#body').hide();
					$("#print").hide();

					
					window.print();
					setTimeout(function(){ 
						$('#body').show();
						$("#printContent").hide();
						$("#print").show();
					}, 1000);
				}				
		</script>
	</head>
	<body>
		<div id="header" class="center">
			
			<div id="title"> 
				<img  id="logo" src="IMAGES/student.jpg" alt="Item added" > 
				Student Management System 
				<div id="print"> 
					<table>
						<tr>
							<td>
								<input type="button" value="Generate Reports" id="btnPrint" onclick="printContent('printContent')"/>
							</td>
							<td>
								<select id="reportDuration">
									<option value="W">Weekly</option>
									<option value="M">Monthly</option>
								</select>							
							</td> 					
							<td>
								<select id="reportType">
									<option value="S">Student</option>
									<option value="P">Program</option>
								</select>							
							</td> 					
						</tr>
					</table>
				</div>
					
			<br>
			</div>
			<div style="clear: both;"></div>
		</div>

		<br><br>
		<div id="body" > 

			<table id="example" class="display" width="100%">
			</table>

			
			<div id="subtitle" > 
				<hr/>
				<div id="subtitleText" > Add/Edit</div>
				<hr/>
			</div>
			<div class="center"> 
				<form id="frmCadastre">
					<table>
						<input id="txtRow" name="txtRow" type="hidden">				
						<input id="txtDetails" name="txtDetails" type="hidden">				
						<input id="txtEdit" name="txtEdit" type="hidden">				
						<input id="txtDelete" name="txtDelete" type="hidden">				
						<tr>
							<td><label for="txtID">ID:</label></td>
							<td><input type="text" id="txtID" /></td> 
							<td>
								<span class="error" id="errorID" > </span>
							</td> 
						</tr>
						<tr>
							<td><label for="txtName">Name:</label></td>
							<td><input type="text" id="txtName" /></td> 
							<td>
								<span class="error" id="errorName" > </span>
							</td> 						
						</tr>
						<tr>
							<td><label for="txtGrade">Grade:</label></td>
							<td>
								<!-- <input type="text" id="txtGrade" /> -->
								<select id="txtGrade" >
									<option value="">Select Grade</option>
									<option value="A">A</option>
									<option value="B">B</option>
									<option value="C">C</option>
									<option value="D">D</option>
									<option value="F">F</option>
								</select>							
							</td> 
							<td>
								<span class="error" id="errorGrade" > </span>
							</td> 							
						</tr>
						<tr>											
							<td><input type="button" value="Save" id="btnSave" onclick="saveData()"/></td> 
							<td><input type="button" value="Clear" id="btnClear"  onclick="formClear()"/></td> 
						</tr>
					</table>
				</form>
			</div> 
			<hr/>	
				

		</div>			
		<div id="printContent" class="center">
			<div id="printTitle" > 
				<hr/>
				<div id="printTitleText" > Student Community Service Report</div>
				<hr/>
			</div>
			<br><br>
			<table id = "printTable" class="printTableStyle">
				<tbody id="printTableBody">

				</tbody>
			</table>
		</div>
	</body>	
</html>